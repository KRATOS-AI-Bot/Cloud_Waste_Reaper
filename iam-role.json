
import json
import os
import boto3
import urllib
import argparse
from datetime import datetime

try:
    from tabulate import tabulate
    HAS_TABULATE = True
except ImportError:
    HAS_TABULATE = False

def print_table(headers, data):
    if HAS_TABULATE:
        return tabulate(data, headers, tablefmt="grid")
    else:
        table = ""
        table += "| " + " | ".join(headers) + " |\n"
        table += "| " + " | ".join(["---"] * len(headers)) + " |\n"
        for row in data:
            table += "| " + " | ".join(map(str, row)) + " |\n"
        return table

def scan_ebs_volumes():
    ec2 = boto3.client('ec2')
    volumes = ec2.describe_volumes(Filters=[{'Name': 'status', 'Values': ['available']}])
    data = []
    total_savings = 0
    for volume in volumes['Volumes']:
        size = volume['Size']
        cost = size * 0.10
        total_savings += cost
        data.append([volume['VolumeId'], size, volume['VolumeType'], cost, volume['CreateTime']])
    return data, total_savings

def scan_ec2_instances():
    ec2 = boto3.client('ec2')
    instances = ec2.describe_instances()
    data = []
    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            data.append([instance['InstanceId'], instance['InstanceType'], instance['State']['Name']])
    return data

def scan_s3_buckets():
    s3 = boto3.client('s3')
    buckets = s3.list_buckets()
    data = []
    for bucket in buckets['Buckets']:
        data.append([bucket['Name'], bucket['CreationDate']])
    return data

def scan_dynamodb_tables():
    dynamodb = boto3.client('dynamodb')
    tables = dynamodb.list_tables()
    data = []
    for table in tables['TableNames']:
        data.append([table])
    return data

def scan_all_resources():
    ebs_data, total_savings = scan_ebs_volumes()
    ec2_data = scan_ec2_instances()
    s3_data = scan_s3_buckets()
    dynamodb_data = scan_dynamodb_tables()
    report = ""
    report += "EBS Volumes:\n"
    report += print_table(['ID', 'Size(GB)', 'Type', 'Cost($)', 'Created'], ebs_data) + "\n"
    report += "**TOTAL WASTED CASH: $" + str(round(total_savings, 2)) + "**\n\n"
    report += "EC2 Instances:\n"
    report += print_table(['ID', 'Type', 'State'], ec2_data) + "\n\n"
    report += "S3 Buckets:\n"
    report += print_table(['Name', 'Created'], s3_data) + "\n\n"
    report += "DynamoDB Tables:\n"
    report += print_table(['Name'], dynamodb_data) + "\n"
    return report

def send_email_report(body):
    recipient = os.environ.get('SES_RECIPIENT')
    if recipient:
        ses = boto3.client('ses')
        try:
            ses.send_email(
                Source='dakshsawhney2@gmail.com',
                Destination={'ToAddresses': [recipient]},
                Message={
                    'Body': {
                        'Text': {
                            'Data': body
                        }
                    },
                    'Subject': {
                        'Data': 'Cloud Waste Report'
                    }
                }
            )
        except Exception as e:
            print(f"Error sending email: {e}")

def lambda_handler(event, context):
    report = scan_all_resources()
    send_email_report(report)
    return {
        'statusCode': 200,
        'body': json.dumps('Report sent successfully')
    }

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--scan-ebs', action='store_true')
    parser.add_argument('--scan-ec2', action='store_true')
    parser.add_argument('--scan-s3', action='store_true')
    parser.add_argument('--scan-dynamodb', action='store_true')
    parser.add_argument('--scan-all', action='store_true')
    args = parser.parse_args()
    if args.scan_all:
        print(scan_all_resources())
    elif args.scan_ebs:
        ebs_data, total_savings = scan_ebs_volumes()
        print(print_table(['ID', 'Size(GB)', 'Type', 'Cost($)', 'Created'], ebs_data))
        print("**TOTAL WASTED CASH: $" + str(round(total_savings, 2)) + "**")
    elif args.scan_ec2:
        print(print_table(['ID', 'Type', 'State'], scan_ec2_instances()))
    elif args.scan_s3:
        print(print_table(['Name', 'Created'], scan_s3_buckets()))
    elif args.scan_dynamodb:
        print(print_table(['Name'], scan_dynamodb_tables()))
