
import json
import os
import boto3
import urllib
from urllib.parse import urlencode
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import argparse
import sys

try:
    from tabulate import tabulate
    HAS_TABULATE = True
except ImportError:
    HAS_TABULATE = False

def print_table(headers, data):
    if HAS_TABULATE:
        return tabulate(data, headers, tablefmt="grid")
    else:
        table = ""
        table += "+"
        for header in headers:
            table += "---+"
        table += "\n"
        table += "|"
        for header in headers:
            table += f" {header} |"
        table += "\n"
        table += "+"
        for header in headers:
            table += "---+"
        table += "\n"
        for row in data:
            table += "|"
            for item in row:
                table += f" {item} |"
            table += "\n"
        return table

def scan_ebs_volumes():
    ec2 = boto3.client('ec2')
    ebs_volumes = ec2.describe_volumes(
        Filters=[{'Name': 'status', 'Values': ['available']}]
    )['Volumes']
    data = []
    total_cost = 0
    for volume in ebs_volumes:
        size = volume['Size']
        volume_type = volume['VolumeType']
        cost = size * 0.10
        total_cost += cost
        data.append([volume['VolumeId'], size, volume_type, f"${cost:.2f}", volume['CreateTime']])
    return data, total_cost

def scan_ec2_instances():
    ec2 = boto3.client('ec2')
    instances = ec2.describe_instances()
    data = []
    for reservation in instances['Reservations']:
        for instance in reservation['Instances']:
            data.append([instance['InstanceId'], instance['InstanceType'], instance['State']['Name']])
    return data

def scan_s3_buckets():
    s3 = boto3.client('s3')
    buckets = s3.list_buckets()
    data = []
    for bucket in buckets['Buckets']:
        data.append([bucket['Name'], bucket['CreationDate']])
    return data

def scan_dynamodb_tables():
    dynamodb = boto3.client('dynamodb')
    tables = dynamodb.list_tables()
    data = []
    for table in tables['TableNames']:
        data.append([table])
    return data

def scan_all_resources():
    ebs_data, ebs_total_cost = scan_ebs_volumes()
    ec2_data = scan_ec2_instances()
    s3_data = scan_s3_buckets()
    dynamodb_data = scan_dynamodb_tables()
    report = ""
    report += "EBS Volumes:\n"
    report += print_table(["ID", "Size(GB)", "Type", "Cost($)", "Created"], ebs_data)
    report += f"\nTOTAL WASTED CASH: ${ebs_total_cost:.2f}\n\n"
    report += "EC2 Instances:\n"
    report += print_table(["ID", "Type", "State"], ec2_data)
    report += "\n\n"
    report += "S3 Buckets:\n"
    report += print_table(["Name", "Created"], s3_data)
    report += "\n\n"
    report += "DynamoDB Tables:\n"
    report += print_table(["Name"], dynamodb_data)
    return report

def send_email_report(body):
    recipient = os.environ.get('SES_RECIPIENT')
    if not recipient:
        print("SES_RECIPIENT environment variable not set. Email not sent.")
        return
    ses = boto3.client('ses')
    msg = MIMEMultipart()
    msg['Subject'] = 'Cloud Waste Report'
    msg['From'] = 'dakshsawhney2@gmail.com'
    msg['To'] = recipient
    msg.attach(MIMEText(body, 'plain'))
    try:
        ses.send_raw_email(
            RawMessage={'Data': msg.as_string()}
        )
    except Exception as e:
        print(f"Error sending email: {e}")

def lambda_handler(event, context):
    report = scan_all_resources()
    send_email_report(report)
    return {
        'statusCode': 200,
        'body': report
    }

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Cloud Waste Reaper')
    parser.add_argument('--scan-all', action='store_true', help='Scan all resources')
    parser.add_argument('--scan-ebs', action='store_true', help='Scan EBS volumes')
    parser.add_argument('--scan-ec2', action='store_true', help='Scan EC2 instances')
    parser.add_argument('--scan-s3', action='store_true', help='Scan S3 buckets')
    parser.add_argument('--scan-dynamodb', action='store_true', help='Scan DynamoDB tables')
    args = parser.parse_args()
    if args.scan_all:
        print(scan_all_resources())
    elif args.scan_ebs:
        ebs_data, ebs_total_cost = scan_ebs_volumes()
        print(print_table(["ID", "Size(GB)", "Type", "Cost($)", "Created"], ebs_data))
        print(f"TOTAL WASTED CASH: ${ebs_total_cost:.2f}")
    elif args.scan_ec2:
        ec2_data = scan_ec2_instances()
        print(print_table(["ID", "Type", "State"], ec2_data))
    elif args.scan_s3:
        s3_data = scan_s3_buckets()
        print(print_table(["Name", "Created"], s3_data))
    elif args.scan_dynamodb:
        dynamodb_data = scan_dynamodb_tables()
        print(print_table(["Name"], dynamodb_data))
    else:
        parser.print_help()
        sys.exit(1)
