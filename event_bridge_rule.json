
import boto3
import argparse
import json
from tabulate import tabulate
from datetime import datetime
import urllib.request
import urllib.parse

def get_ebs_volumes(ec2, region):
    ebs_volumes = ec2.describe_volumes(
        Filters=[{'Name': 'status', 'Values': ['available']}]
    )['Volumes']
    return ebs_volumes

def calculate_ebs_cost(ebs_volumes):
    total_cost = 0
    ebs_data = []
    for volume in ebs_volumes:
        size = volume['Size']
        cost = size * 0.10
        total_cost += cost
        ebs_data.append([volume['VolumeId'], size, volume['VolumeType'], cost, volume['CreateTime']])
    return ebs_data, total_cost

def get_ec2_instances(ec2, region):
    ec2_instances = ec2.describe_instances(
        Filters=[{'Name': 'instance-state-name', 'Values': ['running', 'stopped', 'pending', 'shutting-down', 'stopping', 'stopped']}]
    )['Reservations']
    return ec2_instances

def get_s3_buckets(s3, region):
    s3_buckets = s3.list_buckets()
    return s3_buckets['Buckets']

def get_dynamodb_tables(dynamodb, region):
    dynamodb_tables = dynamodb.list_tables()
    return dynamodb_tables['TableNames']

def send_email(ses, region, data):
    ses.send_email(
        Source='dakshsawhney2@gmail.com',
        Destination={
            'ToAddresses': ['dakshsawhney2@gmail.com']
        },
        Message={
            'Body': {
                'Text': {
                    'Data': json.dumps(data)
                }
            },
            'Subject': 'Cloud Waste Report'
        }
    )

def lambda_handler(event, context):
    parser = argparse.ArgumentParser()
    parser.add_argument('--scan-ebs', action='store_true')
    parser.add_argument('--delete-ebs')
    parser.add_argument('--delete-all-ebs', action='store_true')
    parser.add_argument('--scan-ec2', action='store_true')
    parser.add_argument('--delete-ec2')
    parser.add_argument('--delete-all-ec2', action='store_true')
    parser.add_argument('--scan-s3', action='store_true')
    parser.add_argument('--delete-s3')
    parser.add_argument('--scan-dynamo', action='store_true')
    parser.add_argument('--delete-dynamo')
    parser.add_argument('--delete-all-dynamo', action='store_true')
    parser.add_argument('--scan-all', action='store_true')
    parser.add_argument('--region', default='ap-south-1')
    args = parser.parse_args()

    ec2 = boto3.client('ec2', region_name=args.region)
    s3 = boto3.client('s3', region_name=args.region)
    dynamodb = boto3.client('dynamodb', region_name=args.region)
    ses = boto3.client('ses', region_name=args.region)

    if args.scan_ebs:
        ebs_volumes = get_ebs_volumes(ec2, args.region)
        ebs_data, total_cost = calculate_ebs_cost(ebs_volumes)
        print(tabulate(ebs_data, headers=['ID', 'Size(GB)', 'Type', 'Cost($)', 'Created'], tablefmt='grid'))
        print(f'\033[1m\033[91mTOTAL WASTED CASH: ${total_cost:.2f}\033[0m')

    if args.scan_ec2:
        ec2_instances = get_ec2_instances(ec2, args.region)
        print(json.dumps(ec2_instances, indent=4))

    if args.scan_s3:
        s3_buckets = get_s3_buckets(s3, args.region)
        print(json.dumps(s3_buckets, indent=4))

    if args.scan_dynamo:
        dynamodb_tables = get_dynamodb_tables(dynamodb, args.region)
        print(json.dumps(dynamodb_tables, indent=4))

    if args.scan_all:
        ebs_volumes = get_ebs_volumes(ec2, args.region)
        ec2_instances = get_ec2_instances(ec2, args.region)
        s3_buckets = get_s3_buckets(s3, args.region)
        dynamodb_tables = get_dynamodb_tables(dynamodb, args.region)
        data = {
            'ebs_volumes': ebs_volumes,
            'ec2_instances': ec2_instances,
            's3_buckets': s3_buckets,
            'dynamodb_tables': dynamodb_tables
        }
        send_email(ses, args.region, data)

    if args.delete_ebs:
        try:
            ec2.delete_volume(VolumeId=args.delete_ebs)
            print(f'EBS volume {args.delete_ebs} deleted successfully')
        except Exception as e:
            print(f'Error deleting EBS volume {args.delete_ebs}: {str(e)}')

    if args.delete_all_ebs:
        ebs_volumes = get_ebs_volumes(ec2, args.region)
        for volume in ebs_volumes:
            try:
                ec2.delete_volume(VolumeId=volume['VolumeId'])
                print(f'EBS volume {volume["VolumeId"]} deleted successfully')
            except Exception as e:
                print(f'Error deleting EBS volume {volume["VolumeId"]}: {str(e)}')

    if args.delete_ec2:
        try:
            ec2.terminate_instances(InstanceIds=[args.delete_ec2])
            print(f'EC2 instance {args.delete_ec2} terminated successfully')
        except Exception as e:
            print(f'Error terminating EC2 instance {args.delete_ec2}: {str(e)}')

    if args.delete_all_ec2:
        ec2_instances = get_ec2_instances(ec2, args.region)
        for instance in ec2_instances:
            try:
                ec2.terminate_instances(InstanceIds=[instance['Instances'][0]['InstanceId']])
                print(f'EC2 instance {instance["Instances"][0]["InstanceId"]} terminated successfully')
            except Exception as e:
                print(f'Error terminating EC2 instance {instance["Instances"][0]["InstanceId"]}: {str(e)}')

    if args.delete_s3:
        try:
            s3.delete_bucket(Bucket=args.delete_s3)
            print(f'S3 bucket {args.delete_s3} deleted successfully')
        except Exception as e:
            print(f'Error deleting S3 bucket {args.delete_s3}: {str(e)}')

    if args.delete_dynamo:
        try:
            dynamodb.delete_table(TableName=args.delete_dynamo)
            print(f'DynamoDB table {args.delete_dynamo} deleted successfully')
        except Exception as e:
            print(f'Error deleting DynamoDB table {args.delete_dynamo}: {str(e)}')

    if args.delete_all_dynamo:
        dynamodb_tables = get_dynamodb_tables(dynamodb, args.region)
        for table in dynamodb_tables:
            try:
                dynamodb.delete_table(TableName=table)
                print(f'DynamoDB table {table} deleted successfully')
            except Exception as e:
                print(f'Error deleting DynamoDB table {table}: {str(e)}')

event_bridge_rule = {
    'Name': 'kratos-lambda-rule',
    'ScheduleExpression': 'cron(0 9 ? * MON *)',
    'EventPattern': '',
    'State': 'ENABLED',
    'Targets': [
        {
            'Id': 'kratos-lambda',
            'Arn': 'arn:aws:lambda:ap-south-1:123456789012:function:kratos-lambda'
        }
    ]
}

